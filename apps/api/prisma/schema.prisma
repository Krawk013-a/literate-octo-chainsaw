// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  role      String   @default("learner") // learner, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  profile           Profile?
  preferences       Preferences?
  progressSnapshots ProgressSnapshot[]
  xpTransactions    XpTransaction[]
  userAchievements  UserAchievement[]
  streaks           Streak[]
  friendshipsInitiated Friendship[] @relation("UserInitiated")
  friendshipsReceived Friendship[] @relation("UserReceived")
  challengesCreated  Challenge[]    @relation("Creator")
  challengesJoined   Challenge[]    @relation("Participant")
  notifications      Notification[]
  exerciseAttempts   ExerciseAttempt[]
  spacedRepetitionQueue SpacedRepetitionQueue[]
  courseEnrollments CourseEnrollment[]
  passwordResetTokens PasswordResetToken[]

  @@map("users")
}

model Profile {
  id          String    @id @default(cuid())
  userId      String    @unique
  firstName   String?
  lastName    String?
  avatar      String?
  bio         String?
  timezone    String    @default("UTC")
  language    String    @default("en")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Preferences {
  id                     String @id @default(cuid())
  userId                 String @unique
  dailyGoalMinutes       Int    @default(30)
  emailNotifications     Boolean @default(true)
  pushNotifications      Boolean @default(true)
  soundEnabled          Boolean @default(true)
  vibrationEnabled      Boolean @default(true)
  darkMode              Boolean @default(false)
  autoPlayAudio         Boolean @default(true)
  showTranslations      Boolean @default(true)
  difficultyLevel       String @default("intermediate") // beginner, intermediate, advanced
  reminderTime          String @default("19:00") // HH:MM format
  weeklyReportDay       Int    @default(1) // 1-7 (Monday-Sunday)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("preferences")
}

// Content Management
model Language {
  id          String @id @default(cuid())
  code        String @unique // e.g., "en", "es", "fr"
  name        String @unique // e.g., "English", "Spanish", "French"
  flag        String? // flag emoji or icon
  isRtl       Boolean @default(false) // right-to-left
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courses Course[]

  @@map("languages")
}

model Course {
  id          String @id @default(cuid())
  languageId  String
  title       String
  description String?
  level       String // beginner, intermediate, advanced
  imageUrl    String?
  isPublished Boolean @default(false)
  sortOrder   Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  language         Language @relation(fields: [languageId], references: [id])
  modules          Module[]
  progressSnapshots ProgressSnapshot[]
  enrollments      CourseEnrollment[]

  @@map("courses")
}

model CourseEnrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  enrolledAt DateTime @default(now())
  completedAt DateTime?
  progress   Float    @default(0) // 0-100 percentage
  lastAccessedAt DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("course_enrollments")
}

model Module {
  id          String @id @default(cuid())
  courseId    String
  title       String
  description String?
  sortOrder   Int    @default(0)
  isPublished Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons  Lesson[]

  @@map("modules")
}

model Lesson {
  id          String @id @default(cuid())
  moduleId    String
  title       String
  description String?
  type        String // reading, listening, speaking, writing, grammar, vocabulary
  sortOrder   Int    @default(0)
  isPublished Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module        Module          @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  sections      LessonSection[]
  exercises     Exercise[]
  progressSnapshots ProgressSnapshot[]

  @@map("lessons")
}

model LessonSection {
  id       String @id @default(cuid())
  lessonId String
  title    String
  content  Json   // Rich text content, can include media
  type     String // text, audio, video, image, interactive
  order    Int    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("lesson_sections")
}

// Exercise System
model Exercise {
  id          String @id @default(cuid())
  lessonId    String
  type        String // multiple_choice, translation, fill_blank, speaking, listening, writing
  question    Json   // Question data structure
  answer      Json   // Correct answer structure
  hints       Json?  // Optional hints
  difficulty  String @default("medium") // easy, medium, hard
  points      Int    @default(10)
  timeLimit   Int?   // Time limit in seconds
  sortOrder   Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lesson          Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  prompts         ExercisePrompt[]
  attempts        ExerciseAttempt[]

  @@map("exercises")
}

model ExercisePrompt {
  id         String @id @default(cuid())
  exerciseId String
  prompt     String // The prompt text or audio
  type       String // text, audio, image
  data       Json?  // Additional prompt data (audio URL, image URL, etc.)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("exercise_prompts")
}

model ExerciseAttempt {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String
  answer     Json     // User's answer
  isCorrect  Boolean
  score      Int      // Points earned
  timeSpent  Int      // Time spent in seconds
  attempts   Int      @default(1) // Number of attempts for this exercise
  createdAt  DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("exercise_attempts")
}

// Progress and Learning System
model ProgressSnapshot {
  id           String   @id @default(cuid())
  userId       String
  courseId     String?
  lessonId     String?
  completedAt  DateTime @default(now())
  timeSpent    Int      // Time spent in seconds
  score        Int?     // Overall score for this session
  xpEarned     Int      @default(0)
  streakBonus  Boolean  @default(false)

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  lesson Lesson? @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  @@map("progress_snapshots")
}

model SpacedRepetitionQueue {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String
  nextReview DateTime
  interval   Int      // Days until next review
  easeFactor Float    @default(2.5) // SM-2 algorithm ease factor
  repetitions Int     @default(0)   // Number of successful repetitions
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, exerciseId])
  @@map("spaced_repetition_queue")
}

// Gamification System
model Streak {
  id        String   @id @default(cuid())
  userId    String @unique
  current   Int      @default(0)
  longest   Int      @default(0)
  lastActive DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("streaks")
}

model XpTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // Can be positive or negative
  reason      String   // Reason for XP change (e.g., "lesson_completed", "streak_bonus")
  sourceId    String?  // ID of related entity (lesson, exercise, etc.)
  sourceType  String?  // Type of related entity (lesson, exercise, achievement, etc.)
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("xp_transactions")
}

model Achievement {
  id          String @id @default(cuid())
  name        String @unique
  description String
  icon        String?
  badgeColor  String @default("#blue") // CSS color class
  xpReward    Int    @default(0)
  condition   Json   // Conditions to unlock (e.g., {"type": "streak", "value": 7})
  isActive    Boolean @default(true)
  sortOrder   Int    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())
  progress      Json?    // Progress data for multi-step achievements

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Leaderboard {
  id          String @id @default(cuid())
  name        String @unique
  description String?
  type        String // weekly, monthly, all_time, course_specific
  courseId    String? // If course-specific
  isActive    Boolean @default(true)
  resetPeriod String? // "weekly", "monthly", etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("leaderboards")
}

// Social Features
model Friendship {
  id         String   @id @default(cuid())
  user1Id    String
  user2Id    String
  status     String   // pending, accepted, blocked
  initiatedBy String  // user1Id or user2Id
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user1 User @relation("UserInitiated", fields: [user1Id], references: [id], onDelete: Cascade)
  user2 User @relation("UserReceived", fields: [user2Id], references: [id], onDelete: Cascade)

  @@unique([user1Id, user2Id])
  @@map("friendships")
}

model Challenge {
  id          String   @id @default(cuid())
  creatorId   String
  title       String
  description String?
  type        String   // xp_race, streak_competition, course_completion
  targetValue Int      // Target value for the challenge
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  maxParticipants Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creator     User     @relation("Creator", fields: [creatorId], references: [id])
  participants User[]  @relation("Participant")

  @@map("challenges")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // reminder, achievement, challenge, friendship, system
  title     String
  message   String
  data      Json?    // Additional notification data
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// Password Reset
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("password_reset_tokens")
}